{% extends "base.html" %}

{% load jstemplate %}
{% load i18n %}
{% load url from future %}
{% load shareabouts_utils %}

{% block load_early %}
{% endblock load_early %}

{% block header %}
{% endblock header %}

{% block content %}
  {% handlebarsjs '(.*)' %}

<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <button class="btn btn-navbar btn-navbar-left btn-full-icon">
        <span class="icon-screenshot icon-white"></span>
      </button>

      <a class="brand" href="#">Surveyor</a>
    </div>
  </div>
</div><!--/.navbar-->

<div class="container">
  <div id="top-map"></div>
  <div id="content"></div>
</div> <!-- /container -->
{% endblock content %}

{% block load_late %}
  <script src="{{ STATIC_URL }}surveyor/app.js"></script>

  <script>
    (function(S) {
      // Set the config values
      S.config = {{ config|as_json }};

      // Template helpers
      Handlebars.registerHelper('isInput', function(options) {
        if (!this.type || (this.type !== 'textarea' && this.type !== 'select' && this.type !== 'file')) {
          return options.fn(this);
        }
      });

      Handlebars.registerHelper('isTextarea', function(options) {
        if (this.type === 'textarea') {
          return options.fn(this);
        }
      });

      Handlebars.registerHelper('isSelect', function(options) {
        if (this.type === 'select') {
          return options.fn(this);
        }
      });

      Handlebars.registerHelper('isFile', function(options) {
        if (this.type === 'file') {
          return options.fn(this);
        }
      });

      Handlebars.registerHelper('isFileInputSupported', function(options) {
        if (Shareabouts.Util.fileInputSupported()) {
          return options.fn(this);
        } else {
          return options.inverse(this);
        }
      });

      Handlebars.registerHelper('getAttr', function(obj, attr, options) {
        if (obj !== undefined) {
          return obj[attr];
        }
      });

      Handlebars.registerHelper('select', function(value, options) {
        var $el = $('<select />').html(options.fn(this));
        $el.find('[value="' + value + '"]').attr('selected', 'selected');
        return $el.html();
      });

      // Initialise the templates
      var placeListSource = $('#place-list-tpl').html(),
          placeFormSource = $('#place-form-tpl').html(),
          placeItemSource = $('#place-item-tpl').html(),
          spinnerOptions = {
            lines: 13, // The number of lines to draw
            length: 20, // The length of each line
            width: 10, // The line thickness
            radius: 30, // The radius of the inner circle
            corners: 1, // Corner roundness (0..1)
            rotate: 0, // The rotation offset
            direction: 1, // 1: clockwise, -1: counterclockwise
            color: '#000', // #rgb or #rrggbb
            speed: 1, // Rounds per second
            trail: 60, // Afterglow percentage
            shadow: false, // Whether to render a shadow
            hwaccel: false, // Whether to use hardware acceleration
            className: 'load-spinner', // The CSS class to assign to the spinner
            zIndex: 2e9, // The z-index (defaults to 2000000000)
            top: 'auto', // Top position relative to parent in px
            left: 'auto' // Left position relative to parent in px
          };

      // Helper function
      S.fetchNearbyPlaces = function(lat, lng) {
        // Fetch new data near this place
        S.placeCollection.fetch({
          reset: true,
          data: {
            include_submissions: true,
            near: lat+','+lng
          }
        });
      };

      Handlebars.registerPartial('place-item-tpl', placeItemSource);
      S.placeListTemplate = Handlebars.compile(placeListSource);
      S.placeFormTemplate = Handlebars.compile(placeFormSource);

      // Setup a shared spinner
      S.loadSpinner = new Spinner(spinnerOptions);

      // Create our place collection
      S.placeCollection = new Shareabouts.PlaceCollection([], {responseType: 'survey'});

      // Create the router
      S.router = new S.Router({content: '#content'});

      // Create the list view
      S.placeListView = new S.PlaceListView({
        collection: S.placeCollection,
        template: S.placeListTemplate
      });
      S.placeFormViews = {};

      // Create the content managing view
      S.contentView = new S.ContentView({
        el: '#content'
      });

      // Create the map view
      S.mapView = new S.MapView({
        el: '#top-map',
        mapConfig: S.config.map,
        collection: S.placeCollection
      });

      // The geolocation event
      S.currentLocation = null;

      S.mapView.on('locationfound', function(evt) {
        S.currentLocation = evt;
        console.log(evt);
        S.fetchNearbyPlaces(evt.latlng.lat, evt.latlng.lng);
      });

      S.mapView.on('locationerror', function(evt) {
        console.log(evt);
        if (!S.currentLocation) {
          S.fetchNearbyPlaces(S.config.map.options.center.lat, S.config.map.options.center.lng);
        }
      });

      Backbone.history.start({pushState: true});
    }(Surveyor));
  </script>
{% endblock load_late %}
